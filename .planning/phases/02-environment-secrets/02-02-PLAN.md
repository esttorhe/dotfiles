---
phase: 02-environment-secrets
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - dot_config/private_fish/config.fish.tmpl
autonomous: true
user_setup:
  - service: 1Password
    why: "SSH agent and secrets storage"
    env_vars: []
    dashboard_config:
      - task: "Ensure 1Password SSH agent is enabled"
        location: "1Password Settings -> Developer -> SSH Agent"
    notes: "Already configured from zsh setup - no new action needed if working"

must_haves:
  truths:
    - "SSH_AUTH_SOCK points to correct 1Password agent socket"
    - "1Password socket path is OS-specific (different on macOS vs Linux)"
    - "Cloudflare headers variable is populated from 1Password"
    - "OpenWeather API key is populated from 1Password"
    - "Secrets are not hardcoded in config"
  artifacts:
    - path: "dot_config/private_fish/config.fish.tmpl"
      provides: "1Password integration and secrets"
      contains: "SSH_AUTH_SOCK"
  key_links:
    - from: "config.fish.tmpl"
      to: "1Password"
      via: "chezmoi onepasswordRead"
      pattern: "onepasswordRead"
    - from: "SSH_AUTH_SOCK"
      to: "1Password agent socket"
      via: "OS-specific path"
      pattern: "1password.*agent.sock"
---

<objective>
Configure 1Password SSH agent and chezmoi-templated secrets in fish config

Purpose: Enable SSH authentication via 1Password and load secrets (Cloudflare, OpenWeather) from 1Password vault
Output: Working 1Password SSH integration and populated secret environment variables
</objective>

<execution_context>
@/Users/esteban.torres/.claude/get-shit-done/workflows/execute-plan.md
@/Users/esteban.torres/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@dot_config/private_fish/config.fish.tmpl
@dot_zsh/_variables.zsh.tmpl
@dot_zshrc.tmpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 1Password SSH_AUTH_SOCK configuration</name>
  <files>dot_config/private_fish/config.fish.tmpl</files>
  <action>
Add 1Password SSH agent configuration to the config file.

The SSH_AUTH_SOCK path differs by OS:
- macOS: `~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock`
- Linux: `~/.1password/agent.sock`

Add a dedicated secrets section after PATH configuration:

```fish
# ============================================
# Secrets and 1Password integration
# ============================================

# 1Password SSH Agent
{{ if eq .chezmoi.os "darwin" }}
set -gx SSH_AUTH_SOCK "$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
{{ else if eq .chezmoi.os "linux" }}
set -gx SSH_AUTH_SOCK "$HOME/.1password/agent.sock"
{{ end }}
```

Note: In fish, we don't need to escape spaces in paths when using quotes. The `$HOME` variable will expand correctly.
  </action>
  <verify>
Run `chezmoi execute-template < dot_config/private_fish/config.fish.tmpl` and verify:
- Output contains `set -gx SSH_AUTH_SOCK` with correct path for current OS
- Template conditionals are syntactically correct
  </verify>
  <done>SSH_AUTH_SOCK configured with OS-specific 1Password agent socket path</done>
</task>

<task type="auto">
  <name>Task 2: Add 1Password-sourced secrets</name>
  <files>dot_config/private_fish/config.fish.tmpl</files>
  <action>
Add secrets that are populated from 1Password via chezmoi templating.

These secrets use chezmoi's `onepasswordRead` function which retrieves values at `chezmoi apply` time (not runtime).

Add after SSH_AUTH_SOCK:

```fish
# Cloudflare Zero Trust headers (for Infisical and other internal tools)
set -gx INFISICAL_CUSTOM_HEADERS "CF-Access-Client-Id={{ onepasswordRead "op://Private/CF-Access-Client-Id/password" }} CF-Access-Client-Secret={{ onepasswordRead "op://Private/CF-Access-Client-Secret/password" }}"

# OpenWeather API key
set -gx OPEN_WEATHER_API_KEY "{{ onepasswordRead "op://Private/OPENWEATHER_API/password" }}"
```

Important notes:
- The `{{` and `}}` are chezmoi template delimiters (already configured at top of file)
- Secrets are baked into the config at `chezmoi apply` time
- The actual secret values will appear in the deployed `~/.config/fish/config.fish` (which is why the directory uses `private_fish` prefix for restrictive permissions)
- If 1Password CLI is not authenticated, `chezmoi apply` will fail/prompt
  </action>
  <verify>
Run `chezmoi execute-template < dot_config/private_fish/config.fish.tmpl 2>&1` and check:
- If 1Password is authenticated: template renders with actual secret values
- If not authenticated: error message about 1Password (expected)
- Template syntax is valid (no parse errors)
  </verify>
  <done>1Password-sourced secrets (Cloudflare headers, OpenWeather key) configured in fish config</done>
</task>

<task type="auto">
  <name>Task 3: Apply config and verify secrets integration</name>
  <files>dot_config/private_fish/config.fish.tmpl</files>
  <action>
Apply the complete config and verify secrets are working.

1. Run `chezmoi apply` to deploy config
   - This will prompt for 1Password authentication if needed
   - If 1Password auth fails, that's a user setup issue (not a code issue)

2. Verify in fish shell:
```fish
# Check SSH_AUTH_SOCK is set and socket exists
echo $SSH_AUTH_SOCK
test -S $SSH_AUTH_SOCK && echo "Socket exists" || echo "Socket not found"

# Check secrets are populated (don't echo full values for security)
test -n "$INFISICAL_CUSTOM_HEADERS" && echo "Cloudflare headers: set" || echo "Cloudflare headers: NOT SET"
test -n "$OPEN_WEATHER_API_KEY" && echo "OpenWeather key: set" || echo "OpenWeather key: NOT SET"

# Test SSH via 1Password agent
ssh -T git@github.com 2>&1 | head -1
```

3. Verify file permissions:
```bash
ls -la ~/.config/fish/config.fish
# Should show restrictive permissions (600 or similar)
```
  </action>
  <verify>
Verification commands:
- `fish -c 'echo $SSH_AUTH_SOCK'` returns 1Password socket path
- `fish -c 'test -S $SSH_AUTH_SOCK && echo ok'` returns "ok" (socket exists)
- `fish -c 'test -n "$OPEN_WEATHER_API_KEY" && echo set'` returns "set"
- `ssh -T git@github.com` authenticates successfully (or returns "Hi username!")
  </verify>
  <done>Secrets populated from 1Password and SSH agent working</done>
</task>

</tasks>

<verification>
After all tasks:
1. `chezmoi apply` completes without errors
2. `fish -c 'echo $SSH_AUTH_SOCK'` outputs correct 1Password socket path
3. `fish -c 'test -S $SSH_AUTH_SOCK; echo $status'` outputs "0" (socket exists)
4. `fish -c 'test -n "$INFISICAL_CUSTOM_HEADERS"; echo $status'` outputs "0" (variable set)
5. `fish -c 'test -n "$OPEN_WEATHER_API_KEY"; echo $status'` outputs "0" (variable set)
6. `ssh -T git@github.com` works via 1Password SSH agent
7. `ls -la ~/.config/fish/config.fish` shows restrictive permissions (not world-readable)
</verification>

<success_criteria>
- SSH_AUTH_SOCK correctly points to 1Password agent socket for current OS
- 1Password secrets populated via chezmoi templating
- SSH authentication works via 1Password agent
- Config file has appropriate permissions (secrets not exposed)
- Fish shell starts without errors with all secrets available
</success_criteria>

<output>
After completion, create `.planning/phases/02-environment-secrets/02-02-SUMMARY.md`
</output>
