# ABOUTME: Tmux configuration with Dracula Pro theme
# ABOUTME: Vim-aware bindings, icon-based window names, powerline status bar

# Set the default shell
set-option -g default-shell $SHELL
set-option -g default-command $SHELL

# make tmux display things in 256 colors
set -g default-terminal "xterm-screen-256color"

# set scrollback history to 10000 (10k)
set -g history-limit 10000

# set Ctrl-x as the default prefix key combination
set -g prefix C-x
unbind C-b

# shorten command delay
set -sg escape-time 2

# ============================================================================
# Vim detection for smart bindings
# ============================================================================

is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?|bob)(diff)?$'"

# ============================================================================
# Key bindings
# ============================================================================

bind C-l send-keys 'C-l'
bind R source-file ~/.tmux.conf \; display-message "  Config reloaded.."
bind C-a send-prefix

# Window/pane management
unbind %
unbind '"'
bind t new-window -c "#{pane_current_path}"
bind e split-window -h -c "#{pane_current_path}"
bind E split-window -v -c "#{pane_current_path}"
bind T swap-window -t 1

# Vim-aware save/close/quit bindings
bind S if-shell "$is_vim" "send-keys :w Enter" ""
bind W if-shell "$is_vim" "send-keys :bd Enter" "kill-pane"
bind Q if-shell "$is_vim" "send-keys :qa! Enter" "confirm-before -p 'Kill window? (y/n)' kill-window"

# Vi-style pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

bind p previous-window
bind n next-window
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+

# Pane resizing
bind H resize-pane -L 5
bind J resize-pane -D 5
bind K resize-pane -U 5
bind L resize-pane -R 5

# Mouse support
bind m run "cut -c3- ~/.tmux/tmux.conf.funcs | sh -s _toggle_mouse"
set -g mouse on

# Alt+arrow pane navigation (no prefix)
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# === Session Management with Sesh ===
bind-key "o" display-popup -E -w 40% "sesh connect \"$(
  sesh list -i | gum filter --limit 1 --placeholder 'Pick a sesh' --prompt='‚ö°'
)\""

bind-key "j" run-shell "sesh connect \"$(
  sesh list -i | fzf-tmux -p 55%,60% \
    --no-sort --border-label ' sesh ' --prompt '‚ö°  ' \
    --header '  ^a all ^t tmux ^x zoxide ^g config ^k tmux kill ^f find' \
    --bind 'tab:down,btab:up' \
    --bind 'ctrl-a:change-prompt(‚ö°  )+reload(sesh list -i)' \
    --bind 'ctrl-t:change-prompt(ü™ü  )+reload(sesh list -it)' \
    --bind 'ctrl-g:change-prompt(‚öôÔ∏è  )+reload(sesh list -ic)' \
    --bind 'ctrl-x:change-prompt(üìÅ  )+reload(sesh list -iz)' \
    --bind 'ctrl-f:change-prompt(üîé  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
    --bind 'ctrl-k:execute(tmux kill-session -t {})+change-prompt(‚ö°  )+reload(sesh list)'
)\""

# Quick pane kill (skip confirmation)
bind-key x kill-pane

# Load dev layout
bind D source ~/.config/tmux/tmux_dev

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity off

# Start window numbering at 1
set -g base-index 1
set -g pane-base-index 1

# Don't exit tmux when closing a session
set -g detach-on-destroy off

# Creates a new session (and a new window group)
new-session -s main

# yazi image preview
set -g allow-passthrough on

set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM
set -ga update-environment OPEN_WEATHER_API_KEY

# Set API keys for plugins
set-environment -g OPEN_WEATHER_API_KEY "{{onepasswordRead "op://Private/OPENWEATHER_API/password"}}"

# ============================================================================
# Dracula Pro Van Helsing Theme
# ============================================================================

# Colors
BG="#0B0D0F"
FG="#F8F8F2"
GREEN="#8AFF80"
PURPLE="#9580FF"
PINK="#FF80BF"
CYAN="#80FFEA"
YELLOW="#FFFF80"
ORANGE="#FFAA99"
SURFACE="#414D58"

# Powerline separators
RIGHT_SEP="ÓÇ∞"
LEFT_SEP="ÓÇ≤"

# General status bar settings
set -g status-position top
set -g status-style "bg=$BG,fg=$FG"
set -g status-interval 5
set -g status-left-length 100
set -g status-right-length 100

# Left side: home icon with powerline separator
set -g status-left "#[fg=$BG,bg=$GREEN,bold] Û∞Ä∂ #[fg=$GREEN,bg=$BG]$RIGHT_SEP"

# Right side: session, time
set -g status-right "#[fg=$SURFACE,bg=$BG]$LEFT_SEP#[fg=$FG,bg=$SURFACE] #S #[fg=$PURPLE,bg=$SURFACE]$LEFT_SEP#[fg=$BG,bg=$PURPLE,bold]  %H:%M "

# ============================================================================
# Icon-based window naming
# ============================================================================

# Allow automatic rename; manually renamed windows (prefix + ,) keep their name
set -g automatic-rename on
set -g automatic-rename-format "#{b:pane_current_path}"

# Icon lookup based on pane_current_command (claude detected via pane_title ‚ú≥ symbol)
ICON="\
#{?#{==:#{pane_current_command},nvim},Óò´,\
#{?#{==:#{pane_current_command},vim},Óò´,\
#{?#{==:#{pane_current_command},bob},Óò´,\
#{?#{==:#{pane_current_command},lazygit},ÓúÇ,\
#{?#{==:#{pane_current_command},lg},ÓúÇ,\
#{?#{==:#{pane_current_command},lazydocker},Û∞°®,\
#{?#{==:#{pane_current_command},ldo},Û∞°®,\
#{?#{==:#{pane_current_command},yazi},ÓúÖ,\
#{?#{==:#{pane_current_command},htop},Û∞çõ,\
#{?#{==:#{pane_current_command},btop},Û∞çõ,\
#{?#{m:*‚ú≥*,#{pane_title}},Û∞ö©,\
#{?#{==:#{pane_current_command},node},Óúò,\
#{?#{==:#{pane_current_command},python},Óúº,\
#{?#{==:#{pane_current_command},go},Óú§,}}}}}}}}}}}}}}"

# Inactive windows
set -g window-status-format "#[fg=$FG,bg=$BG] #I $ICON #W "
set -g window-status-separator ""

# Active window with powerline style
set -g window-status-current-format "#[fg=$PURPLE,bg=$BG]#[fg=$BG,bg=$PURPLE,bold]$RIGHT_SEP #I $ICON #W #[fg=$PURPLE,bg=$BG]$RIGHT_SEP"

# Pane borders
set -g pane-border-style "fg=$SURFACE"
set -g pane-active-border-style "fg=$PURPLE"

# Window activity styling (keep colors consistent with theme)
set -g window-status-activity-style "fg=$CYAN,bg=$BG"
set -g window-status-bell-style "fg=$YELLOW,bg=$BG"

# Message and command styling
set -g message-style "bg=$PURPLE,fg=$BG"
set -g message-command-style "bg=$PURPLE,fg=$BG"

# ============================================================================
# Plugins
# ============================================================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'alberti42/tmux-fzf-links'
set -g @plugin 'jaclu/tmux-menus'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Last saved environment is automatically restored when tmux is started.
set -g @continuum-restore 'on'

# === tmux-fzf-links ===
set-option -g @fzf-links-key 'f'
set-option -g @fzf-links-editor-open-cmd "tmux new-window -n 'vi' /opt/homebrew/bin/nvim +%line '%file'"
set-option -g @fzf-links-fzf-path "fzf"
set-option -g @fzf-links-fzf-display-options "-w 100% --maxnum-displayed 20 --multi --track --no-preview"
set-option -g @fzf-links-python "python3"
set-option -g @fzf-links-use-colors on
set-option -g @fzf-links-hide-bottom-bar off

# alt +u (original shortcut) does not work well on mac
set -g @tpm-clean 'u'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
